<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Ojek Online</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      overflow: hidden;
      height: 100vh;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 600px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .header {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
      z-index: 10;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .map-container {
      flex: 1;
      position: relative;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .panel {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      background: white;
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      z-index: 5;
      transition: all 0.3s ease;
    }

    .input-group {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      position: relative;
    }

    .input-group i {
      position: absolute;
      left: 15px;
      color: #4285f4;
      font-size: 18px;
    }

    input {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: border 0.3s;
      background: #f8f9fa;
    }

    input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }

    .pac-container {
      z-index: 10000 !important;
      border-radius: 12px !important;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15) !important;
      border: none !important;
      margin-top: 5px;
    }
    
    .pac-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .pac-item:last-child {
      border-bottom: none;
    }
    
    .pac-item:hover {
      background-color: #f5f7fa;
    }
    
    .pac-icon {
      display: none;
    }
    
    .pac-item-query {
      font-size: 15px;
      color: #333;
      font-weight: 500;
    }
    
    .pac-matched {
      font-weight: bold;
      color: #4285f4;
    }

    .order-summary {
      background: white;
      border-radius: 20px 20px 0 0;
      padding: 25px 20px;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 10;
      position: relative;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .summary-header h2 {
      color: #4285f4;
      font-size: 1.4rem;
    }

    .vehicle-type {
      background: #e8f0fe;
      color: #4285f4;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    .location-item {
      display: flex;
      margin-bottom: 20px;
    }

    .location-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .pickup-icon {
      background: #4285f4;
      color: white;
    }

    .destination-icon {
      background: #34a853;
      color: white;
    }

    .location-details {
      flex: 1;
    }

    .location-details h3 {
      font-size: 16px;
      margin-bottom: 5px;
      color: #555;
    }

    .location-details p {
      font-size: 14px;
      color: #888;
    }

    .divider {
      height: 1px;
      background: #eee;
      margin: 10px 0 20px 55px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 0 10px;
    }

    .info-label {
      color: #777;
      font-size: 15px;
    }

    .info-value {
      font-weight: 600;
      font-size: 15px;
      color: #333;
    }

    .price-value {
      color: #ea4335;
      font-size: 1.4rem;
      font-weight: 700;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn i {
      margin-right: 8px;
    }

    .cancel-btn {
      background: #f8f9fa;
      color: #ea4335;
      border: 1px solid #eee;
    }

    .cancel-btn:hover {
      background: #f1f3f4;
    }

    .find-btn {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
    }

    .find-btn:hover {
      opacity: 0.95;
      transform: translateY(-2px);
    }

    .driver-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 20;
      padding: 25px;
      display: flex;
      flex-direction: column;
      overflow-y: auto; /* Memungkinkan konten discroll */
      display: none;
    }

    .driver-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .driver-info {
      text-align: center;
      margin-bottom: 30px;
    }

    .driver-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4285f4, #34a853);
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 40px;
      border: 4px solid white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .driver-info h2 {
      font-size: 1.6rem;
      margin-bottom: 5px;
      color: #333;
    }

    .driver-rating {
      color: #fbbc05;
      margin-bottom: 15px;
    }

    .driver-vehicle {
      background: #e8f0fe;
      color: #4285f4;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      display: inline-block;
      margin-top: 10px;
    }

    .contact-btn {
      display: block;
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      border-radius: 14px;
      font-weight: 600;
      font-size: 18px;
      border: none;
      cursor: pointer;
      margin-top: auto; /* Posisi tetap di bawah */
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
      transition: all 0.2s;
      text-decoration: none;
      text-align: center;
    }

    .contact-btn:hover {
      opacity: 0.95;
      transform: translateY(-2px);
    }

    .back-btn {
      background: #f1f3f4;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #555;
    }

    .status-bar {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
      font-weight: 600;
      color: #ea4335;
      border: 1px solid #eee;
    }

    .radar {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%);
      z-index: 999;
      display: none;
    }

    .radar::before, .radar::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      border: 2px solid #00BFFF;
      border-radius: 50%;
      animation: radarPulse 2s infinite ease-out;
    }

    .radar::after {
      animation-delay: 1s;
    }

    .radar span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00BFFF;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    @keyframes radarPulse {
      0% { transform: scale(0.4); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }

    .loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
      flex-direction: column;
      display: none;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(66, 133, 244, 0.2);
      border-top: 5px solid #4285f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading p {
      font-size: 18px;
      color: #4285f4;
      font-weight: 600;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 10px;
      display: none;
    }

    .notification.success {
      border-left: 4px solid #34a853;
    }

    .notification.error {
      border-left: 4px solid #ea4335;
    }

    .notification i {
      font-size: 24px;
    }

    .success i {
      color: #34a853;
    }

    .error i {
      color: #ea4335;
    }
    
    .error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 1000;
      display: none;
      max-width: 90%;
      width: 320px;
    }
    
    .error-message h3 {
      color: #ea4335;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .error-message p {
      color: #555;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .error-message button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .error-message button:hover {
      background: #3367d6;
    }
    
    .status-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 500;
      z-index: 6;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: none;
    }
    
    .status-pending {
      color: #fbbc05;
      border: 1px solid #fbbc05;
    }
    
    .status-accepted {
      color: #34a853;
      border: 1px solid #34a853;
    }
    
    .status-cancelled {
      color: #ea4335;
      border: 1px solid #ea4335;
    }
    
    .driver-details {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #eee;
    }
    
    .driver-detail-item {
      display: flex;
      margin-bottom: 15px;
    }
    
    .driver-detail-item:last-child {
      margin-bottom: 0;
    }
    
    .driver-detail-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e8f0fe;
      color: #4285f4;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
    }
    
    .driver-detail-content {
      flex: 1;
    }
    
    .driver-detail-label {
      font-size: 14px;
      color: #777;
      margin-bottom: 3px;
    }
    
    .driver-detail-value {
      font-weight: 600;
      font-size: 16px;
      color: #333;
    }
    
    .completion-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      display: none;
    }
    
    .completion-check {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #34a853;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      animation: scaleUp 0.5s ease-out;
    }
    
    .completion-check i {
      color: white;
      font-size: 60px;
    }
    
    .completion-message {
      font-size: 28px;
      font-weight: 700;
      color: #34a853;
      text-align: center;
      margin-bottom: 20px;
      animation: fadeIn 1s ease-out;
    }
    
    .completion-description {
      font-size: 18px;
      color: #555;
      text-align: center;
      max-width: 80%;
      line-height: 1.5;
      margin-bottom: 30px;
    }
    
    .completion-button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
    }
    
    .completion-button:hover {
      background: #3367d6;
      transform: translateY(-2px);
    }
    
    @keyframes scaleUp {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Order Ojek Online</h1>
      <p>Pesan kendaraan dengan mudah dan cepat</p>
    </div>
    
    <div class="map-container">
      <div id="map"></div>
      
      <div class="panel">
        <div class="input-group">
          <i class="fas fa-map-marker-alt"></i>
          <input type="text" id="fromInput" placeholder="Lokasi jemput" autocomplete="off">
        </div>
        <div class="input-group">
          <i class="fas fa-flag"></i>
          <input type="text" id="toInput" placeholder="Tujuan" autocomplete="off">
        </div>
      </div>
      
      <div class="radar" id="radar">
        <span>Mencari driver...</span>
      </div>
      
      <div class="status-indicator" id="statusIndicator"></div>
    </div>
    
    <div class="order-summary" id="orderSummary">
      <div class="summary-header">
        <h2>Ringkasan Order</h2>
        <div class="vehicle-type" id="vehicleTypeDisplay">MOTOR</div>
      </div>
      
      <div class="location-item">
        <div class="location-icon pickup-icon">
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="location-details">
          <h3>Lokasi Jemput</h3>
          <p id="pickupAddress">-</p>
        </div>
      </div>
      
      <div class="location-item">
        <div class="location-icon destination-icon">
          <i class="fas fa-flag"></i>
        </div>
        <div class="location-details">
          <h3>Lokasi Tujuan</h3>
          <p id="destinationAddress">-</p>
        </div>
      </div>
      
      <div class="divider"></div>
      
      <div class="info-row">
        <div class="info-label">Durasi Perjalanan</div>
        <div class="info-value" id="duration">-</div>
      </div>
      
      <div class="info-row">
        <div class="info-label">Jarak</div>
        <div class="info-value" id="distance">-</div>
      </div>
      
      <div class="info-row">
        <div class="info-label">Total Harga</div>
        <div class="price-value" id="totalPrice">Rp 0</div>
      </div>
      
      <div class="action-buttons">
        <button class="btn cancel-btn" id="cancelBtn">
          <i class="fas fa-times"></i> Batalkan
        </button>
        <button class="btn find-btn" id="findDriverBtn">
          <i class="fas fa-motorcycle"></i> Cari Driver
        </button>
      </div>
    </div>
    
    <div class="driver-screen" id="driverScreen">
      <div class="driver-header">
        <h2>Driver Ditemukan</h2>
        <button class="back-btn" id="backBtn">
          <i class="fas fa-arrow-left"></i>
        </button>
      </div>
      
      <div class="driver-info">
        <div class="driver-avatar">
          <i class="fas fa-user"></i>
        </div>
        <h2 id="driverName">-</h2>
        <div class="driver-rating">
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star-half-alt"></i>
          <span>4.7</span>
        </div>
        <div class="driver-vehicle">
          <i class="fas fa-motorcycle"></i>
          <span id="driverVehicleType">-</span>
        </div>
      </div>
      
      <div class="driver-details">
        <div class="driver-detail-item">
          <div class="driver-detail-icon">
            <i class="fas fa-id-card"></i>
          </div>
          <div class="driver-detail-content">
            <div class="driver-detail-label">ID Driver</div>
            <div class="driver-detail-value" id="driverID">-</div>
          </div>
        </div>
        
        <div class="driver-detail-item">
          <div class="driver-detail-icon">
            <i class="fas fa-phone"></i>
          </div>
          <div class="driver-detail-content">
            <div class="driver-detail-label">Nomor Telepon</div>
            <div class="driver-detail-value" id="driverPhone">-</div>
          </div>
        </div>
        
        <div class="driver-detail-item">
          <div class="driver-detail-icon">
            <i class="fas fa-car"></i>
          </div>
          <div class="driver-detail-content">
            <div class="driver-detail-label">Jenis Kendaraan</div>
            <div class="driver-detail-value" id="driverVehicle">-</div>
          </div>
        </div>
        
        <div class="driver-detail-item">
          <div class="driver-detail-icon">
            <i class="fas fa-barcode"></i>
          </div>
          <div class="driver-detail-content">
            <div class="driver-detail-label">Nomor Kendaraan</div>
            <div class="driver-detail-value" id="driverPlate">-</div>
          </div>
        </div>
      </div>
      
      <div class="status-bar">
        <i class="fas fa-check-circle"></i>
        <span id="driverStatusText">Driver dalam perjalanan menuju lokasi Anda</span>
      </div>
      
      <a href="#" class="contact-btn" id="contactDriverBtn">
        <i class="fas fa-phone"></i> Hubungi Driver
      </a>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p id="loadingText">Memproses...</p>
    </div>
    
    <div class="error-message" id="errorMessage">
      <h3>Error: Autocomplete Tidak Berfungsi</h3>
      <p id="errorDetail">Pastikan API Key memiliki akses ke Google Places API dan Maps JavaScript API.</p>
      <button id="reloadBtn">Coba Lagi</button>
    </div>
    
    <div class="completion-animation" id="completionAnimation">
      <div class="completion-check">
        <i class="fas fa-check"></i>
      </div>
      <div class="completion-message">Order Berhasil Diselesaikan!</div>
      <div class="completion-description">Driver telah mengambil paket Anda. Terima kasih telah menggunakan layanan kami.</div>
      <button class="completion-button" id="completionButton">Kembali ke Beranda</button>
    </div>
  </div>
  
  <div class="notification" id="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notificationText">Order berhasil dikirim!</span>
  </div>

  <script>
    // Data order
    const orderData = {
      from: "",
      to: "",
      vehicle: "",
      distance: "",
      duration: "",
      totalPrice: 0,
      userID: "",
      userName: "",
      phone: "",
      photo_url: "", // Tambahkan field untuk foto profil
      status: "pending",
      from_lat: 0,
      from_lng: 0,
      to_lat: 0,
      to_lng: 0
    };

    const driverData = {
      driverID: "",
      driverName: "",
      driverPhone: "",
      kendaraan_driver: "",
      jenis_kendaraan: "",
      nomor_kendaraan: ""
    };

    // Firebase
    let firebaseDb;
    let firebaseInitialized = false;
    let orderRef;
    let routeCalculated = false;
    
    // Google Maps
    let map;
    let directionsService;
    let directionsRenderer;
    let markerA, markerB;
    let autocompleteFrom, autocompleteTo;
    let mapInitialized = false;

    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Get all required parameters
    const getUrlParam = (param) => {
      return urlParams.get(param) || "";
    };
    
    // Initialize order data from URL parameters
    function initOrderData() {
      orderData.vehicle = getUrlParam("vehicle") || "motor";
      orderData.userID = getUrlParam("userID");
      orderData.userName = getUrlParam("userName");
      orderData.phone = getUrlParam("phone");
      orderData.order_id = getUrlParam("order_id");
      orderData.photo_url = getUrlParam("photo_url"); // Ambil photo_url dari parameter URL
      
      // Set harga per km
      const hargaPerKm = parseFloat(getUrlParam("harga")) || 0;
      orderData.hargaPerKm = hargaPerKm;
      
      // Set initial locations
      const fromParam = getUrlParam("from");
      const toParam = getUrlParam("to");
      
      if (fromParam) {
        const [lat, lng] = fromParam.split(",").map(Number);
        if (!isNaN(lat) && !isNaN(lng)) {
          orderData.from_lat = lat;
          orderData.from_lng = lng;
        }
      }
      
      if (toParam) {
        const [lat, lng] = toParam.split(",").map(Number);
        if (!isNaN(lat) && !isNaN(lng)) {
          orderData.to_lat = lat;
          orderData.to_lng = lng;
        }
      }
      
      // Set vehicle type display
      const vehicleNames = {
        motor: "MOTOR",
        mobil: "MOBIL",
        kurir: "KURIR",
        bentor: "BENTOR",
        pickup: "PICKUP",
        pickup_scooter: "PICKUP SCOOTER"
      };
      
      document.getElementById("vehicleTypeDisplay").textContent = 
        vehicleNames[orderData.vehicle] || "MOTOR";
    }

    // Fungsi inisialisasi peta
    function initMap() {
      try {
        // Initialize map
        const lokasiA = { 
          lat: orderData.from_lat || -6.2088, 
          lng: orderData.from_lng || 106.8456 
        };
        
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: lokasiA,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
          styles: [
            { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#333333" }] },
            {
              featureType: "road",
              elementType: "geometry",
              stylers: [{ color: "#ffffff" }]
            },
            {
              featureType: "road",
              elementType: "labels.text.fill",
              stylers: [{ color: "#5a5a5a" }]
            },
            {
              featureType: "poi",
              elementType: "geometry",
              stylers: [{ color: "#f5f5f5" }]
            },
            {
              featureType: "water",
              elementType: "geometry",
              stylers: [{ color: "#c9e7ff" }]
            }
          ]
        });
        
        // Initialize directions service
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true,
          polylineOptions: {
            strokeColor: "#4285f4",
            strokeOpacity: 0.8,
            strokeWeight: 5
          }
        });
        
        // Add markers if locations are provided
        if (orderData.from_lat && orderData.from_lng) {
          const lokasiA = { lat: orderData.from_lat, lng: orderData.from_lng };
          markerA = new google.maps.Marker({
            position: lokasiA,
            map: map,
            icon: {
              url: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
              scaledSize: new google.maps.Size(40, 40)
            }
          });
          
          // Reverse geocode to get address
          reverseGeocode(lokasiA, (address) => {
            if (address) {
              orderData.from = address;
              document.getElementById("fromInput").value = address;
              document.getElementById("pickupAddress").textContent = address;
            }
          });
        }
        
        if (orderData.to_lat && orderData.to_lng) {
          const lokasiB = { lat: orderData.to_lat, lng: orderData.to_lng };
          markerB = new google.maps.Marker({
            position: lokasiB,
            map: map,
            icon: {
              url: "https://cdn-icons-png.flaticon.com/512/447/447031.png",
              scaledSize: new google.maps.Size(40, 40)
            }
          });
          
          // Reverse geocode to get address
          reverseGeocode(lokasiB, (address) => {
            if (address) {
              orderData.to = address;
              document.getElementById("toInput").value = address;
              document.getElementById("destinationAddress").textContent = address;
            }
          });
        }
        
        // Initialize autocomplete
        initAutocomplete();
        mapInitialized = true;
        
        // Calculate route if both locations are provided
        if (orderData.from_lat && orderData.from_lng && 
            orderData.to_lat && orderData.to_lng) {
          calculateRoute();
        } else {
          // Show order summary if both addresses are available
          if (orderData.from && orderData.to) {
            showOrderSummary();
          }
        }
        
      } catch (error) {
        console.error("Error initializing map:", error);
        showError("Terjadi kesalahan saat memuat peta. Pastikan API Key valid dan memiliki akses ke Maps JavaScript API.");
      }
    }

    // Fungsi untuk inisialisasi autocomplete
    function initAutocomplete() {
      try {
        // Define Indonesia bounds
        const southWest = new google.maps.LatLng(-11.0, 95.0);
        const northEast = new google.maps.LatLng(6.0, 141.0);
        const indonesiaBounds = new google.maps.LatLngBounds(southWest, northEast);
        
        // Inisialisasi autocomplete untuk input jemput
        autocompleteFrom = new google.maps.places.Autocomplete(
          document.getElementById('fromInput'),
          {
            // types: ['geocode'], // ← ini dihapus atau dikomentari
fields: ['geometry', 'formatted_address', 'name', 'place_id'],
            componentRestrictions: { country: 'id' }, // Batasi ke Indonesia
            bounds: indonesiaBounds, // Batasi wilayah ke Indonesia
            strictBounds: false
          }
        );

        // Inisialisasi autocomplete untuk input tujuan
        autocompleteTo = new google.maps.places.Autocomplete(
          document.getElementById('toInput'),
          {
            // types: ['geocode'], // ← ini dihapus atau dikomentari
fields: ['geometry', 'formatted_address', 'name', 'place_id'],
            componentRestrictions: { country: 'id' }, // Batasi ke Indonesia
            bounds: indonesiaBounds, // Batasi wilayah ke Indonesia
            strictBounds: false
          }
        );

        // Tambahkan event listener untuk jemput
        autocompleteFrom.addListener('place_changed', function() {
          const place = autocompleteFrom.getPlace();
          if (!place.geometry) {
            console.error("Place details not available for input: 'fromInput'");
            return;
          }
          
          // Update data order
          orderData.from = place.formatted_address;
          orderData.from_lat = place.geometry.location.lat();
          orderData.from_lng = place.geometry.location.lng();
          
          // Update UI
          document.getElementById("pickupAddress").textContent = place.formatted_address;
          
          // Add/update marker
          if (markerA) markerA.setMap(null);
          markerA = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            icon: {
              url: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
              scaledSize: new google.maps.Size(40, 40)
            }
          });
          
          // Pan to new location
          map.panTo(place.geometry.location);
          
          // Calculate route if destination is available
          if (markerB) {
            calculateRoute();
          } else if (orderData.to) {
            showOrderSummary();
          }
        });

        // Tambahkan event listener untuk tujuan
        autocompleteTo.addListener('place_changed', function() {
          const place = autocompleteTo.getPlace();
          if (!place.geometry) {
            console.error("Place details not available for input: 'toInput'");
            return;
          }
          
          // Update data order
          orderData.to = place.formatted_address;
          orderData.to_lat = place.geometry.location.lat();
          orderData.to_lng = place.geometry.location.lng();
          
          // Update UI
          document.getElementById("destinationAddress").textContent = place.formatted_address;
          
          // Add/update marker
          if (markerB) markerB.setMap(null);
          markerB = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            icon: {
              url: "https://cdn-icons-png.flaticon.com/512/447/447031.png",
              scaledSize: new google.maps.Size(40, 40)
            }
          });
          
          // Calculate route if start location is available
          if (markerA) {
            calculateRoute();
          } else if (orderData.from) {
            showOrderSummary();
          }
        });

        console.log("Autocomplete initialized successfully with Indonesia restrictions");
        
      } catch (error) {
        console.error("Error initializing autocomplete:", error);
        showError("Terjadi kesalahan saat memuat fitur pencarian alamat. Pastikan API Key memiliki akses ke Google Places API.");
      }
    }

    // Calculate route between two points
    function calculateRoute() {
      if (!markerA || !markerB) return;
      
      const from = markerA.getPosition();
      const to = markerB.getPosition();
      
      document.getElementById("loadingText").textContent = "Menghitung rute...";
      document.getElementById("loading").style.display = "flex";
      
      directionsService.route({
        origin: from,
        destination: to,
        travelMode: google.maps.TravelMode.DRIVING,
        region: "ID",
        drivingOptions: {
          departureTime: new Date(),
          trafficModel: google.maps.TrafficModel.BEST_GUESS
        },
        provideRouteAlternatives: false
      }, (response, status) => {
        document.getElementById("loading").style.display = "none";
        
        if (status === "OK") {
          directionsRenderer.setDirections(response);
          const leg = response.routes[0].legs[0];
          
          // Get duration with traffic
          const durationText = leg.duration_in_traffic ? 
            leg.duration_in_traffic.text : leg.duration.text;
            
          // Calculate price
          const distanceKm = leg.distance.value / 1000;
          
          // Harga minimum berdasarkan jenis kendaraan
          const hargaMinimum = {
            motor: 10000,
            bentor: 13000,
            kurir: 10000,
            mobil: 15000,
            pickup: 90000,
            pickup_scooter: 12000
          };
          
          let totalPrice = Math.round(distanceKm * orderData.hargaPerKm);
          const minHarga = hargaMinimum[orderData.vehicle] || 10000;
          if (totalPrice < minHarga) {
            totalPrice = minHarga;
          }
          
          // Update order data
          orderData.distance = leg.distance.text;
          orderData.duration = durationText;
          orderData.totalPrice = totalPrice;
          
          // Update UI
          document.getElementById("duration").textContent = durationText;
          document.getElementById("distance").textContent = leg.distance.text;
          document.getElementById("totalPrice").textContent = `Rp ${totalPrice.toLocaleString("id-ID")}`;
          
          // Show order summary
          showOrderSummary();
          routeCalculated = true;
        } else {
          showNotification(`Gagal menghitung rute: ${status}`, "error");
        }
      });
    }

    // Fungsi untuk menampilkan ringkasan order
    function showOrderSummary() {
      if (!orderData.from || !orderData.to) return;
      
      document.getElementById("orderSummary").style.display = "block";
      document.getElementById("pickupAddress").textContent = orderData.from;
      document.getElementById("destinationAddress").textContent = orderData.to;
      
      // Animasi scroll ke atas
      document.querySelector(".order-summary").scrollIntoView({ behavior: "smooth" });
    }

    // Initialize Firebase
    function initFirebase() {
      try {
        const firebaseConfigParam = getUrlParam("firebaseConfig");
        if (!firebaseConfigParam) {
          console.log("Firebase config not provided");
          return;
        }
        
        // Decode and parse Firebase config
        const decodedConfig = decodeURIComponent(firebaseConfigParam);
        const firebaseConfig = JSON.parse(decodedConfig);
        
        // Load Firebase scripts dynamically
        const firebaseScript = document.createElement('script');
        firebaseScript.src = 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js';
        firebaseScript.onload = () => {
          const authScript = document.createElement('script');
          authScript.src = 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js';
          authScript.onload = () => {
            firebase.initializeApp(firebaseConfig);
            firebaseDb = firebase.database();
            firebaseInitialized = true;
            console.log('Firebase initialized successfully');
            
            // Setup Firebase listener
            setupFirebaseListener();
          };
          document.head.appendChild(authScript);
        };
        document.head.appendChild(firebaseScript);
        
      } catch (e) {
        console.error('Firebase initialization error:', e);
        showNotification('Error initializing Firebase: ' + e.message, 'error');
      }
    }

    // Setup Firebase listener for order status changes
    function setupFirebaseListener() {
      if (!firebaseInitialized || !orderData.order_id) return;
      
      orderRef = firebaseDb.ref(`orders/${orderData.order_id}`);
      
      orderRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        
        // Update order status
        orderData.status = data.status || "pending";
        
        // Handle status changes
        handleStatusChange(data);
      });
    }

    // Handle order status changes
    function handleStatusChange(data) {
      const statusIndicator = document.getElementById("statusIndicator");
      
      switch (orderData.status) {
        case "dibatalkan_penumpang":
          statusIndicator.textContent = "Order Dibatalkan";
          statusIndicator.className = "status-indicator status-cancelled";
          statusIndicator.style.display = "block";
          
          // Tampilkan tombol back
          document.getElementById("backBtn").style.display = "block";
          
          showNotification("Order telah dibatalkan", "error");
          resetOrderForm();
          break;
          
        case "di_ambil":
          statusIndicator.textContent = "Driver Menuju Lokasi";
          statusIndicator.className = "status-indicator status-accepted";
          statusIndicator.style.display = "block";
          
          // Sembunyikan radar
          document.getElementById("radar").style.display = "none";
          
          // Sembunyikan tombol back
          document.getElementById("backBtn").style.display = "none";
          
          // Update driver data
          driverData.driverID = data.driverID || "";
          driverData.driverName = data.driverName || "";
          driverData.driverPhone = data.driverPhone || "";
          driverData.kendaraan_driver = data.kendaraan_driver || "";
          driverData.jenis_kendaraan = data.jenis_kendaraan || "Motor";
          driverData.nomor_kendaraan = data.nomor_kendaraan || "B 1234 ABC";
          
          // Show driver notification
          showNotification("Driver ditemukan! " + driverData.driverName + " sedang menuju lokasi Anda", "success");
          
          // Show driver screen
          showDriverScreen();
          break;
          
        case "dalam_perjalanan":
          statusIndicator.textContent = "Dalam Perjalanan";
          statusIndicator.className = "status-indicator status-accepted";
          statusIndicator.style.display = "block";
          
          document.getElementById("driverStatusText").textContent = 
            "Sedang dalam perjalanan menuju tujuan";
          break;
          
        case "selesai":
          // Tampilkan tombol back
          document.getElementById("backBtn").style.display = "block";
          
          // Show completion animation
          document.getElementById("completionAnimation").style.display = "flex";
          break;
      }
      
      // Send status to app
      sendToAppInventor({
        action: "status_update",
        status: orderData.status,
        order_id: orderData.order_id
      });
    }

    // Send order to Firebase
    function sendOrderToFirebase() {
      if (!firebaseInitialized) {
        showNotification("Firebase belum diinisialisasi", "error");
        return;
      }
      
      if (!orderData.order_id) {
        showNotification("ID Order tidak ditemukan", "error");
        return;
      }
      
      if (!routeCalculated) {
        showNotification("Harap tentukan rute terlebih dahulu", "error");
        return;
      }
      
      document.getElementById("loadingText").textContent = "Mengirim order...";
      document.getElementById("loading").style.display = "flex";
      
      // Sembunyikan tombol "Cari Driver" dan ubah tampilan tombol "Batalkan"
      document.getElementById("findDriverBtn").style.display = "none";
      document.getElementById("cancelBtn").style.flex = "1";
      document.getElementById("cancelBtn").style.maxWidth = "100%";
      
      // Prepare order data dengan menyertakan photo_url
      const orderPayload = {
        from: orderData.from,
        to: orderData.to,
        from_latlng: `${orderData.from_lat},${orderData.from_lng}`,
        to_latlng: `${orderData.to_lat},${orderData.to_lng}`,
        vehicle: orderData.vehicle,
        distance: orderData.distance,
        duration: orderData.duration,
        totalPrice: orderData.totalPrice,
        userID: orderData.userID,
        userName: orderData.userName,
        phone: orderData.phone,
        photo_url: orderData.photo_url || "", // Sertakan photo_url
        status: "pending",
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      
      // Send to Firebase
      orderRef.set(orderPayload)
        .then(() => {
          document.getElementById("loading").style.display = "none";
          showNotification("Order berhasil dikirim! Mencari driver...", "success");
          
          // Show radar animation
          document.getElementById("radar").style.display = "flex";
          
          // Update status indicator
          const statusIndicator = document.getElementById("statusIndicator");
          statusIndicator.textContent = "Mencari Driver";
          statusIndicator.className = "status-indicator status-pending";
          statusIndicator.style.display = "block";
          
          // Hide notification after 3 seconds
          setTimeout(() => {
            document.getElementById("notification").style.display = "none";
          }, 3000);
        })
        .catch((error) => {
          document.getElementById("loading").style.display = "none";
          showNotification("Gagal mengirim order: " + error.message, "error");
        });
    }

    // Fungsi untuk menampilkan layar driver
    function showDriverScreen() {
      document.getElementById("driverScreen").style.display = "flex";
      document.getElementById("driverName").textContent = driverData.driverName;
      document.getElementById("driverID").textContent = driverData.driverID;
      document.getElementById("driverPhone").textContent = driverData.driverPhone;
      document.getElementById("driverVehicle").textContent = driverData.jenis_kendaraan;
      document.getElementById("driverPlate").textContent = driverData.nomor_kendaraan;
      document.getElementById("driverVehicleType").textContent = driverData.kendaraan_driver;
      document.getElementById("driverPickupAddress").textContent = orderData.from;
      document.getElementById("driverDestinationAddress").textContent = orderData.to;
      document.getElementById("driverDuration").textContent = orderData.duration;
      document.getElementById("driverPrice").textContent = `Rp ${orderData.totalPrice.toLocaleString("id-ID")}`;
      
      // Update contact button
      const contactBtn = document.getElementById("contactDriverBtn");
      if (driverData.driverPhone) {
        contactBtn.href = `tel:${driverData.driverPhone}`;
        contactBtn.style.display = "block";
      } else {
        contactBtn.style.display = "none";
      }
    }

    // Reverse geocode function
    function reverseGeocode(latlng, callback) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: latlng }, (results, status) => {
        if (status === 'OK' && results[0]) {
          callback(results[0].formatted_address);
        } else {
          callback(null);
        }
      });
    }

    // Show notification
    function showNotification(message, type) {
      const notification = document.getElementById("notification");
      notification.querySelector("#notificationText").textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = "flex";
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        notification.style.display = "none";
      }, 5000);
    }

    // Show error message
    function showError(message) {
      const errorEl = document.getElementById("errorMessage");
      errorEl.querySelector("#errorDetail").textContent = message;
      errorEl.style.display = 'block';
    }

    // Reset order form
    function resetOrderForm() {
      document.getElementById("orderSummary").style.display = "none";
      document.getElementById("fromInput").value = "";
      document.getElementById("toInput").value = "";
      document.getElementById("pickupAddress").textContent = "-";
      document.getElementById("destinationAddress").textContent = "-";
      
      // Tampilkan kembali tombol "Cari Driver"
      document.getElementById("findDriverBtn").style.display = "block";
      document.getElementById("cancelBtn").style.flex = "";
      document.getElementById("cancelBtn").style.maxWidth = "";
      
      if (markerA) markerA.setMap(null);
      if (markerB) markerB.setMap(null);
      if (directionsRenderer) directionsRenderer.setMap(null);
      
      // Reset order data
      orderData.from = "";
      orderData.to = "";
      orderData.distance = "";
      orderData.duration = "";
      orderData.totalPrice = 0;
      routeCalculated = false;
    }

    // Send data to App Inventor
    function sendToAppInventor(data) {
      const jsonData = JSON.stringify(data);
      
      // Android
      if (window.AppInventor && window.AppInventor.setWebViewString) {
        window.AppInventor.setWebViewString(jsonData);
      }
      // iOS
      else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.iosHandler) {
        window.webkit.messageHandlers.iosHandler.postMessage(jsonData);
      }
      // Android alternative
      else if (window.AndroidInterface) {
        window.AndroidInterface.receiveData(jsonData);
      }
      else {
        console.log("App Inventor interface not found. Data:", data);
      }
    }

    // Event listeners saat halaman dimuat
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize order data from URL parameters
      initOrderData();
      
      // Initialize Firebase
      initFirebase();
      
      // Event listener untuk tombol "Cari Driver"
      document.getElementById("findDriverBtn").addEventListener("click", sendOrderToFirebase);
      
      // Event listener untuk tombol "Batalkan"
      document.getElementById("cancelBtn").addEventListener("click", () => {
        if (firebaseInitialized && orderRef) {
          // Update status in Firebase
          orderRef.update({ status: "dibatalkan_penumpang" })
            .then(() => {
              showNotification("Order dibatalkan", "error");
              resetOrderForm();
            })
            .catch(error => {
              showNotification("Gagal membatalkan order: " + error.message, "error");
            });
        } else {
          showNotification("Order dibatalkan", "error");
          resetOrderForm();
        }
      });
      
      // Event listener untuk tombol kembali di layar driver
      document.getElementById("backBtn").addEventListener("click", () => {
        document.getElementById("driverScreen").style.display = "none";
      });
      
      // Event listener untuk tombol reload error
      document.getElementById("reloadBtn").addEventListener("click", () => {
        location.reload();
      });
      
      // Event listener untuk tombol selesai
      document.getElementById("completionButton").addEventListener("click", () => {
        // Kirim perintah ke App Inventor untuk kembali ke halaman utama
        sendToAppInventor({ action: "go_home" });
      });
    });
  </script>
  
  <script>
    // Load Google Maps API
    const key = new URLSearchParams(window.location.search).get("key");
    if (key) {
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places&callback=initMap`;
      script.async = true;
      script.defer = true;
      
      // Add error handler
      script.onerror = function() {
        showError("Gagal memuat Google Maps API. Pastikan API Key valid dan memiliki akses ke Maps JavaScript API dan Places API.");
      };
      
      document.head.appendChild(script);
      
      // Check if map initialized after 5 seconds
      setTimeout(() => {
        if (!mapInitialized) {
          showError("Gagal memuat Google Maps API. Pastikan API Key valid dan memiliki akses ke Maps JavaScript API dan Places API.");
        }
      }, 5000);
      
    } else {
      showError("API Key Google Maps tidak ditemukan di URL. Silakan tambahkan parameter key=API_KEY");
    }
  </script>
</body>
</html>
